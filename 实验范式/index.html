<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="./jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        :root {box-sizing: border-box;}
        *,::before,::after{box-sizing: inherit;}
        .handleSpace {position: fixed;left:0;top:0;}
        .time {width: 20px;height: 30px;border:1px solid sienna;}
        .f1-box, .f2-box {width: 900px;margin: 0 auto;display: flex;flex-direction: row;flex-wrap: wrap;font-weight: bolder;}
        .f2-box {display: none;}
        .box {border: 1px solid #42b983;width: 290px;height: 250px;}
        .text-char {font-size:50px;text-align:center;margin-top:20%;}
        .inputstyle{width:99%;height:98%;font-size:100px}
        .black-ground {position:fixed;top:0;left:0;zoom:1;background-repeat:no-repeat;width:100%;height:100%;background-image: url("pic.jpg");background-size:100% 100%; }
    </style>
</head>
<body>
<div class="black-ground"></div>
<div class="handleSpace">
    <button class="connect-bluetooth" onclick="connectBluetooth()">连接设备</button>
    <button class="handle-btn" onclick="numberBegin()">开始</button>
    <div class="time"></div>
    <button class="handle-btn" onclick="checkAnswer()">填写完毕</button>
    <button class="handle-btn" onclick="downloadReport()">生成文件</button>
</div>
<div class="f1-box">
    <div class="square1 box"></div>
    <div class="square2 box"></div>
    <div class="square3 box"></div>
    <div class="square4 box"></div>
    <div class="square5 box"></div>
    <div class="square6 box"></div>
    <div class="square7 box"></div>
    <div class="square8 box"></div>
    <div class="square9 box"></div>
</div>
<div class="f2-box">
    <div class="box"><input id="input1" class="inputstyle" type="text"></div>
    <div class="box"><input id="input2" class="inputstyle" type="text"></div>
    <div class="box"><input id="input3" class="inputstyle" type="text"></div>
    <div class="box"><input id="input4" class="inputstyle" type="text"></div>
    <div class="box"><input id="input5" class="inputstyle" type="text"></div>
    <div class="box"><input id="input6" class="inputstyle" type="text"></div>
    <div class="box"><input id="input7" class="inputstyle" type="text"></div>
    <div class="box"><input id="input8" class="inputstyle" type="text"></div>
    <div class="box"><input id="input9" class="inputstyle" type="text"></div>
</div>
<script>
    var answer = []
    var requestArr = []
    var rightAnswer = 0
    var myCharacteristic
    var testData = '';
    function downloadReport() {
        var blob = new Blob([this.string2buffer(testData)], {type: 'application/octet-stream'})
        saveAs(blob, 'report.eeg')
    }
    function connectBluetooth() {
        navigator.bluetooth.requestDevice({
            filters: [{ services: ['0000ff00-0000-1000-8000-00805f9b34fb']}]
        }).then(device => {
            console.log('device')
            return device.gatt.connect();
        }).then(server => {
            return server.getPrimaryService('0000ff00-0000-1000-8000-00805f9b34fb')
        }).then(service => {
            console.log('service')
            console.log(service)
            
            return service.getCharacteristic('0000ff01-0000-1000-8000-00805f9b34fb')
        }).then(characteristics => {
            // console.log(characteristics)
            myCharacteristic = characteristics
            myCharacteristic.addEventListener('characteristicvaluechanged', test)
            return myCharacteristic.startNotifications()
        }).catch(error => {
            console.log(error)
        })
    }
    function test(event) {
        if (myCharacteristic) {
            myCharacteristic.startNotifications()
                .then(note => {
                    var bufferData = note.value.buffer
                    data = ab2hex(bufferData)
                    console.log(data)
                    testData+=data
                })
                .catch(error => {
                    console.log("Argh!" + error);
                });
        }
    }
    // click start
    function numberBegin() {
        console.log(myCharacteristic)
        
        var maxTime = 60; // 60
        var test = 60;
        const testTime = setInterval(()=> {
            test--
            $('.time').text(test)
            if (test === 0) {
                clearInterval(testTime)
            }
        }, 1000)
        // gray background will hide after 60s 
        setTimeout(()=> {
            $('.black-ground').css('display', 'none')
            for (let i = 1; i < 10; i++) {
                var text = Code()
                requestArr.push(text)
                $('.square'+i).html(`<div class="text-char">${requestArr[i-1]}</div>`)
            }
            // 60s code hide look gray background 
            const countDownTimer = setInterval(() => {
                if (maxTime > 0) {
                    -- maxTime;
                    console.log(maxTime)
                }
                if (maxTime === 0) {
                    clearInterval(countDownTimer)
                    $('.f1-box').css('display', 'none')
                    $('.black-ground').css('display', 'block')
                    console.log(requestArr)
                    // 30s look gray background
                    setTimeout(() => {
                        $('.black-ground').css('display', 'none')
                        $('.f2-box').css('display', 'flex')
                    },30000)
                    // 30000
                }
            },1000)
        },60000)
//60000
    }
    // Generate random letters
    function Code() {
        var yuancode = 'AEIOU',
            fucode = 'BCDFGHJKLMNPQRSTVWXYZ',
            ychar = '',
            fchar = '',
            result = '';
            var ycode_index = Math.round(Math.random()*4);
            var ychar = yuancode[ycode_index];
            for (var i = 0; i < 2; i++) {
                var fcode_index = Math.round(Math.random()*20);
                var fchar = fucode[fcode_index];
                if (result.indexOf(fchar) > -1) {
                    i --;
                    continue;
                }
                result += fchar
            }
        return insertStr(result, 1, ychar)
    }
    // string tool 
    function insertStr(soure, start, newStr){
        return soure.slice(0, start) + newStr + soure.slice(start);
    }

    function checkAnswer() {
        myCharacteristic.removeEventListener('characteristicvaluechanged', test)
        // var blob = new Blob([this.string2buffer(writeData)], {type: 'application/octet-stream'})
        $('input').each(function(index,item) {
            answer.push($(this).val())
        })
        console.log(answer)
        console.log(contrastCode(answer, requestArr))
        contrastCode(answer, requestArr)
    }
    // checks two code array
    function contrastCode(arr1,arr2) {
        for (let i = 0; i < 9; i++) {
            if (arr1[i] == arr2[i]) {
                rightAnswer++
            }
        }
        return rightAnswer
    }
    function string2buffer(str) {
        let val = ""
        if(!str) return;
        let length = str.length;
        let index = 0;
        let array = []
        while(index < length){
            array.push(str.substring(index,index+2));
            index = index + 2;
        }
        val = array.join(",");
        // 将16进制转化为ArrayBuffer
        return new Uint8Array(val.match(/[\da-f]{2}/gi).map(function (h) {
        return parseInt(h, 16)
        })).buffer
  }
  function ab2hex(buffer) {
        let hexArr = Array.prototype.map.call(
            new Uint8Array(buffer),
            function (bit) {
                return ('00' + bit.toString(16)).slice(-2)
            }
        )
        return hexArr.join('');
    }
</script>
</body>
</html>
